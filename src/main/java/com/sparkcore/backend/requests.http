### ============================================================
### SparkCore Backend ‚Äì Vollst√§ndiger API Test Suite
### ============================================================
###
### ANLEITUNG:
###  1. docker-compose up -d
###  2. ./mvnw spring-boot:run
###  3. F√ºhre die Schritte 1‚Äì3 aus und trage die Tokens in die Variablen
###     am Anfang dieser Datei ein.
###
### LEGENDE:  ‚úÖ = Erwartet HTTP 2xx
###           üîê = Token erforderlich
###           ‚ùå = Erwartet Fehler (4xx/5xx) ‚Äî Security/Validation Test
### ============================================================

@baseUrl = http://localhost:8080/api/v1

# Hier nach Login eintragen:
@admin_token = eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTc3MjQwMDU1NCwiZXhwIjoxNzcyNDAxNDU0fQ.FpQEp_PJNBJMEE7mnNd6wZmLEpEFbH4xdUhSrYhwYMyPzvbu0axhhNo8e6oqVEa6
@admin_refresh_token = 547c1720-28a6-4345-83f6-0e1cb118d2a0
@user_token = eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJtYXhfbXVzdGVyIiwiaWF0IjoxNzcyNDAwNDcxLCJleHAiOjE3NzI0MDEzNzF9.Ezczo8ct8-zaYmgldv3XHpmqyH6bSXk4AVzRG0DfF-FI-wnwdqhuvGpC7tx0iKQe
@user_refresh_token = 98bfa71c-7d7b-43cc-ad88-6959cded4710

# Hier nach Schritt 4 & 5 eintragen:
@iban_max = DE46100500000284667551
@iban_lisa = DE26100500000563534181


### ============================================================
### SECTION 1: SYSTEM HEALTH
### ============================================================

### [1.1] ‚úÖ Ping ‚Äì √ñffentlich zug√§nglich, kein Token n√∂tig
GET {{baseUrl}}/system/ping


### ============================================================
### SECTION 2: AUTHENTICATION
### ============================================================

### [2.1] ‚úÖ Admin Login ‚Üí Kopiere accessToken ‚Üí @admin_token, refreshToken ‚Üí @admin_refresh_token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "super_secret"
}

###

### [2.2] ‚úÖ Neuen User registrieren
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "username": "max_muster",
  "password": "geheimesPasswort123"
}

###

### [2.3] ‚úÖ Max Muster Login ‚Üí Kopiere accessToken ‚Üí @user_token, refreshToken ‚Üí @user_refresh_token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "max_muster",
  "password": "geheimesPasswort123"
}

###

### [2.4] ‚úÖ Access Token auffrischen (Refresh Token Rotation)
### Nutze wenn @user_token nach 15 Minuten abl√§uft.
### Antwort enth√§lt neues accessToken UND neues refreshToken!
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{user_refresh_token}}"
}

###

### [2.5] ‚úÖ üîê Logout ‚Äì Token wird sofort in Redis gesperrt (Blacklist)
### Danach: Teste [2.6] um sicherzustellen, dass das Token wirklich gesperrt ist!
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{user_token}}

###

### [2.6] ‚ùå Blacklist-Test: Gesperrter Token muss 401 zur√ºckgeben
### NUR ausf√ºhren NACHDEM [2.5] Logout ausgef√ºhrt wurde!
### Erwartete Antwort: 401 Unauthorized mit "Token wurde widerrufen (Logout)."
GET {{baseUrl}}/accounts
Authorization: Bearer {{admin_token}}


### ============================================================
### SECTION 3: SECURITY ‚Äì AUTH ERROR CASES
### ============================================================

### [3.1] ‚ùå Login mit falschem Passwort ‚Üí 401 Unauthorized
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "FALSCHES_PASSWORT"
}

###

### [3.2] ‚ùå Register mit leerem Passwort ‚Üí 400 Bad Request (Bean Validation)
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "username": "bad_user",
  "password": ""
}

###

### [3.3] ‚ùå Refresh mit ung√ºltigem/altem Token ‚Üí 400 Bad Request (RefreshTokenException)
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refreshToken": "this-is-not-a-valid-refresh-token"
}

###

### [3.4] ‚ùå Rate Limiting Test (Brute Force Simulation)
### Klicke 6x schnell hintereinander auf diesen Request.
### Ab Anfrage 6: Erwartete Antwort ist 429 Too Many Requests!
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "wrong_password_brute_force_test"
}


### ============================================================
### SECTION 4: ACCOUNT MANAGEMENT
### ============================================================

### [4.1] ‚úÖ üîê Konto f√ºr Max Mustermann anlegen (UUID IBAN wird generiert)
### ‚Üí Kopiere die IBAN aus der Antwort in @iban_max
POST {{baseUrl}}/accounts
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "ownerName": "Max Mustermann",
  "initialBalance": 1000.50
}

###

### [4.2] ‚úÖ üîê Konto f√ºr Lisa M√ºller anlegen
### ‚Üí Kopiere die IBAN aus der Antwort in @iban_lisa
POST {{baseUrl}}/accounts
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "ownerName": "Lisa M√ºller",
  "initialBalance": 500.00
}

###

### [4.3] ‚úÖ üîê Alle Konten abrufen (Admin-Only)
GET {{baseUrl}}/accounts
Authorization: Bearer {{admin_token}}

###

### [4.4] ‚úÖ üîê Einzelnes Konto per ID abrufen
GET {{baseUrl}}/accounts/1
Authorization: Bearer {{admin_token}}

###

### [4.5] ‚ùå GET nicht-existierendes Konto ‚Üí 404 Not Found
GET {{baseUrl}}/accounts/999999
Authorization: Bearer {{admin_token}}

###

### [4.6] ‚ùå USER versucht alle Konten abzurufen ‚Üí 403 Forbidden (ADMIN-Only)
GET {{baseUrl}}/accounts
Authorization: Bearer {{user_token}}


### ============================================================
### SECTION 5: TRANSACTIONS
### ============================================================

### [5.1] ‚úÖ üîê √úberweisung: Max ‚Üí Lisa (150.50 EUR)
### WICHTIG: Trage die echten IBANs aus Schritt 4 & 5 in @iban_max und @iban_lisa ein!
POST {{baseUrl}}/accounts/transfer
Content-Type: application/json
Authorization: Bearer {{user_token}}

{
  "fromIban": "{{iban_max}}",
  "toIban": "{{iban_lisa}}",
  "amount": 150.50
}

###

### [5.2] ‚úÖ üîê Transaktionshistorie f√ºr Max (nach der √úberweisung in 5.1)
GET {{baseUrl}}/accounts/{{iban_max}}/transactions
Authorization: Bearer {{user_token}}

###

### [5.3] ‚ùå √úberweisung mit falschem IBAN-Format ‚Üí 400 Bad Request (@ValidIban)
POST {{baseUrl}}/accounts/transfer
Content-Type: application/json
Authorization: Bearer {{user_token}}

{
  "fromIban": "KEINE_ECHTE_IBAN",
  "toIban": "{{iban_lisa}}",
  "amount": 10.00
}

###

### [5.4] ‚ùå √úberweisung mit zu wenig Geld ‚Üí 400 Bad Request (Insufficient Funds)
POST {{baseUrl}}/accounts/transfer
Content-Type: application/json
Authorization: Bearer {{user_token}}

{
  "fromIban": "{{iban_max}}",
  "toIban": "{{iban_lisa}}",
  "amount": 999999.99
}

###

### [5.5] ‚ùå ADMIN versucht √úberweisung ‚Üí 403 Forbidden (USER-Only)
POST {{baseUrl}}/accounts/transfer
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "fromIban": "{{iban_max}}",
  "toIban": "{{iban_lisa}}",
  "amount": 10.00
}


### ============================================================
### SECTION 6: AUDIT LOGS
### ============================================================

### [6.1] ‚úÖ üîê Alle Audit-Logs abrufen (Admin-Only)
### Hier sollten Login-Events und Transaktions-Events sichtbar sein!
GET {{baseUrl}}/audit-logs
Authorization: Bearer {{admin_token}}

###

### [6.2] ‚ùå USER versucht Audit-Logs abzurufen ‚Üí 403 Forbidden
GET {{baseUrl}}/audit-logs
Authorization: Bearer {{user_token}}
